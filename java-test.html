<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Programming Tests</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg: #f6f8fa;
      --card: rgba(255,255,255,0.8);
      --border: rgba(208,215,222,0.9);
      --text: #24292f;
      --muted: #6e7781;
      --blue: #0969da;
      --blue-2: #0759b8;
      --green: #2da44e;
      --red: #d1242f;
      --amber: #9a6700;
      --ring-bg: #e5e7eb;
    }
    .dark :root, html.dark {
      --bg: #0d1117;
      --card: rgba(22,27,34,0.7);
      --border: rgba(48,54,61,0.9);
      --text: #e6edf3;
      --muted: #8b949e;
      --ring-bg: #1f2937;
    }
    body { background: radial-gradient(1200px 700px at 10% 10%, #dbeafe 0%, transparent 60%), var(--bg); color: var(--text); }
    .glass { background: var(--card); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 16px; }
    .lift { transition: transform .2s ease, box-shadow .2s ease; }
    .lift:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0,0,0,.12); }
    .progress-fill { transition: width .35s ease, background-color .35s ease; }
    .ring {
      width: 56px; height: 56px; border-radius: 999px; display: grid; place-items: center;
      background: conic-gradient(var(--ring-color, #3b82f6) calc(var(--value, 0) * 1%), var(--ring-bg) 0);
    }
    .ring::after {
      content: ""; width: 44px; height: 44px; border-radius: 999px; background: var(--card); border: 1px solid var(--border);
    }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#1118270d; border:1px solid var(--border); padding:.15rem .4rem; border-radius:6px; font-size:.8rem; }
    .opt:hover { background: rgba(9,105,218,.06); }
    .opt input { accent-color: var(--blue); }
    .badge { border:1px solid var(--border); border-radius:999px; padding:.2rem .6rem; font-size:.75rem; color: var(--muted); background: var(--card); }
    .divider { height:1px; background: var(--border); }
    
  </style>
</head>
<body class="min-h-full">
  <!-- Header -->
  <header class="sticky top-0 z-20 bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <h1 class="text-xl font-semibold"> CodeMaster</h1>
        <div class="w-9 h-9 rounded-md bg-white/15 grid place-items-center font-bold">PT</div>
        <h1 class="text-xl font-semibold">Java Tests</h1>
        <span class="ml-2 badge bg-white/10 text-white/90 border-white/20">Category: Java</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="hidden sm:block text-sm text-white/80">Shortcuts: <span class="kbd">N</span> Next • <span class="kbd">P</span> Prev • <span class="kbd">S</span> Submit • <span class="kbd">C</span> Clear</span>
        <button id="themeToggle" class="glass px-3 py-1 rounded-md lift">Toggle theme</button>
      </div>
      <a href="Platform.html" class="back-link">
    <i class="arrow-icon"></i>
    Back to Home
  </a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Tests grid -->
    <section id="list-section" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-5"></section>

    <!-- Test interface -->
    <section id="test-section" class="hidden">
      <div class="grid lg:grid-cols-[220px,1fr] gap-6">
        <!-- Navigator -->
        <aside class="glass p-4 h-max">
          <div class="flex items-center justify-between mb-3">
            <div class="ring" id="ring" style="--value:0;"><div class="absolute text-xs"></div></div>
            <div class="text-right">
              <div id="timer" class="badge bg-blue-100 text-blue-700 border-0">Time: 00:00</div>
              <div id="progressText" class="text-xs mt-1 text-[var(--muted)]">0 answered</div>
            </div>
          </div>
          <div id="navGrid" class="grid grid-cols-5 gap-2"></div>
          <div class="divider my-4"></div>
          <button id="backBtn" class="w-full glass lift py-2">← Back to tests</button>
        </aside>

        <!-- Paper -->
        <div class="glass p-6">
          <div class="flex items-start justify-between gap-4 flex-wrap">
            <div>
              <h2 id="testTitle" class="text-2xl font-semibold"></h2>
              <p id="meta" class="text-sm text-[var(--muted)] mt-1"></p>
            </div>
            <div class="flex gap-2">
              <span class="badge">Timed</span>
              <span class="badge">Instant result</span>
            </div>
          </div>

          <div class="mt-4">
            <div class="w-full h-2 rounded-full" style="background: var(--ring-bg)">
              <div id="bar" class="h-2 rounded-full progress-fill" style="width:0%; background:#3b82f6;"></div>
            </div>
          </div>

          <form id="form" class="mt-6 space-y-5"></form>

          <div class="divider my-5"></div>

          <div class="flex flex-wrap gap-3">
            <button id="submitBtn" class="px-4 py-2 rounded text-white" style="background: var(--green)">Submit</button>
            <button id="clearBtn" type="button" class="px-4 py-2 rounded text-white" style="background: #d97706">Clear answers</button>
            <button id="resetBtn" type="button" class="px-4 py-2 rounded" style="background: var(--card); border:1px solid var(--border)">Reset</button>
          </div>

          <!-- Results -->
          <div id="resultCard" class="hidden mt-6">
            <div class="text-lg font-semibold">Result</div>
            <p id="scoreText" class="mt-2 text-lg font-bold"></p>
            <div id="answerDetails" class="mt-3 space-y-3 text-sm"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Confetti container -->
  <div id="confetti" class="pointer-events-none fixed inset-0" aria-hidden="true"></div>

  <script>
    // Sample data (replace with your central tests-data.js later)
    const tests = [
      { title: "Programming Test 1", duration: 2, questions: [
        { q: "2 + 3?", options: ["4","5","6","7"], answer: "5" },
        { q: "HTML stands for?", options: ["HyperText Markup Language","HighText","Hyper Transfer","None"], answer: "HyperText Markup Language" }
      ]},
      { title: "Programming Test 2", duration: 3, questions: [
        { q: "CSS stands for?", options: ["Cascading Style Sheets","Creative Style Sheets","Color Sheets","Computer Style"], answer: "Cascading Style Sheets" },
        { q: "JS is used for?", options: ["Backend","Frontend","Both","None"], answer: "Both" }
      ]},
      { title: "Programming Test 3", duration: 2, questions: [
        { q: "Choose a strongly typed language:", options: ["JavaScript","Python","Java","PHP"], answer: "Java" },
        { q: "Which runs in the browser?", options: ["Node.js","JVM","V8",".NET"], answer: "V8" }
      ]}
    ];

    // Auth check
    const user = JSON.parse(localStorage.getItem("loggedInUser") || "{}");
    if (!user.email) {
      alert("Please login to access tests");
      window.location.href = "index.html?auth=login";
    }

    // DOM refs
    const listSection = document.getElementById("list-section");
    const testSection = document.getElementById("test-section");
    const testTitle = document.getElementById("testTitle");
    const meta = document.getElementById("meta");
    const form = document.getElementById("form");
    const submitBtn = document.getElementById("submitBtn");
    const clearBtn = document.getElementById("clearBtn");
    const resetBtn = document.getElementById("resetBtn");
    const backBtn = document.getElementById("backBtn");
    const bar = document.getElementById("bar");
    const ring = document.getElementById("ring");
    const timerEl = document.getElementById("timer");
    const progressText = document.getElementById("progressText");
    const resultCard = document.getElementById("resultCard");
    const scoreText = document.getElementById("scoreText");
    const answerDetails = document.getElementById("answerDetails");
    const navGrid = document.getElementById("navGrid");
    const themeToggle = document.getElementById("themeToggle");
    const confettiWrap = document.getElementById("confetti");

    // State
    let currentIndex = null;
    let timerInt = null;
    let remaining = 0;

    // THEME
    const savedTheme = localStorage.getItem("theme") || "light";
    if (savedTheme === "dark") document.documentElement.classList.add("dark");
    themeToggle.addEventListener("click", () => {
      document.documentElement.classList.toggle("dark");
      localStorage.setItem("theme", document.documentElement.classList.contains("dark") ? "dark" : "light");
    });

    // LIST
    function renderList() {
      listSection.innerHTML = "";
      testSection.classList.add("hidden");
      listSection.classList.remove("hidden");

      tests.forEach((t, i) => {
        const card = document.createElement("div");
        card.className = "glass lift p-5 flex flex-col justify-between";
        card.innerHTML = `
          <div>
            <h3 class="text-lg font-semibold">${t.title}</h3>
            <p class="text-sm" style="color: var(--muted)">${t.questions.length} questions • ${t.duration} min</p>
          </div>
          <button class="mt-4 px-4 py-2 rounded text-white" style="background: var(--blue)">Start</button>
        `;
        card.querySelector("button").addEventListener("click", () => startTest(i));
        listSection.appendChild(card);
      });
    }

    // RING update
    function setRing(value01, color) {
      ring.style.setProperty("--value", value01 * 100);
      ring.style.setProperty("--ring-color", color || "#3b82f6");
      ring.querySelector("div").textContent = `${Math.round(value01*100)}%`;
    }

    // TIMER
    function setTimerBadge() {
      timerEl.className = "badge";
      const t = remaining;
      if (t <= 10) {
        timerEl.classList.add("bg-red-100","text-red-700","border-0");
      } else if (t <= 30) {
        timerEl.classList.add("bg-yellow-100","text-yellow-700","border-0");
      } else {
        timerEl.classList.add("bg-blue-100","text-blue-700","border-0");
      }
    }
    function updateTimer() {
      const m = String(Math.floor(remaining/60)).padStart(2,'0');
      const s = String(remaining%60).padStart(2,'0');
      timerEl.textContent = `Time: ${m}:${s}`;
      setTimerBadge();
    }

    // NAV GRID
    function renderNavigator(total) {
      navGrid.innerHTML = "";
      for (let i=0;i<total;i++) {
        const b = document.createElement("button");
        b.className = "glass lift text-sm py-2";
        b.textContent = i+1;
        b.dataset.index = i;
        b.addEventListener("click", () => scrollToQuestion(i));
        navGrid.appendChild(b);
      }
      updateNavigator();
    }
    function updateNavigator() {
      const total = tests[currentIndex].questions.length;
      for (let i=0;i<total;i++) {
        const btn = navGrid.querySelector(`button[data-index="${i}"]`);
        const checked = form.querySelector(`input[name="q${i}"]:checked`);
        btn.style.borderColor = checked ? "var(--green)" : "var(--border)";
        btn.style.color = checked ? "var(--green)" : "inherit";
      }
    }
    function scrollToQuestion(i) {
      const field = document.getElementById(`qwrap-${i}`);
      if (field) field.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    // PROGRESS
    function updateProgress() {
      const total = tests[currentIndex].questions.length;
      const answered = Array.from(form.querySelectorAll('input[type="radio"]:checked'))
                      .map(i => i.name).filter((v,i,a) => a.indexOf(v) === i).length;
      const pct = total ? answered/total : 0;
      bar.style.width = `${pct*100}%`;
      bar.style.background = pct >= .6 ? "var(--green)" : "#3b82f6";
      setRing(pct);
      progressText.textContent = `${answered} / ${total} answered`;
      updateNavigator();
      clearBtn.disabled = answered === 0;
      clearBtn.style.opacity = answered === 0 ? .6 : 1;
      clearBtn.style.cursor = answered === 0 ? "not-allowed" : "pointer";
    }

    // RENDER TEST
    function startTest(i) {
      currentIndex = i;
      listSection.classList.add("hidden");
      testSection.classList.remove("hidden");
      resultCard.classList.add("hidden");

      const t = tests[i];
      testTitle.textContent = t.title;
      meta.textContent = `${t.questions.length} questions • ${t.duration} min`;
      form.innerHTML = "";

      // Questions
      t.questions.forEach((q, idx) => {
        const field = document.createElement("fieldset");
        field.id = `qwrap-${idx}`;
        field.className = "border rounded-lg p-4";
        field.style.borderColor = "var(--border)";
        field.innerHTML = `<legend class="font-medium">${idx+1}. ${q.q}</legend>`;
        q.options.forEach(opt => {
          const id = `q${idx}-${opt.replace(/\W+/g,'-')}`;
          const label = document.createElement("label");
          label.className = "opt block rounded px-2 py-1 cursor-pointer";
          label.innerHTML = `<input id="${id}" type="radio" name="q${idx}" value="${opt}" class="mr-2"> ${opt}`;
          field.appendChild(label);
        });
        form.appendChild(field);
      });

      // Bind changes
      form.querySelectorAll('input[type="radio"]').forEach(inp => {
        inp.addEventListener("change", updateProgress);
      });

      // Navigator
      renderNavigator(t.questions.length);

      // Reset bars
      bar.style.width = "0%";
      setRing(0);
      progressText.textContent = `0 / ${t.questions.length} answered`;

      // Timer
      clearInterval(timerInt);
      remaining = t.duration * 60;
      updateTimer();
      timerInt = setInterval(() => {
        remaining--;
        if (remaining <= 0) {
          remaining = 0; updateTimer(); clearInterval(timerInt); submit(true);
        } else updateTimer();
      }, 1000);
    }

    // SUBMIT
    function submit(auto=false) {
      clearInterval(timerInt);
      const t = tests[currentIndex];
      let score = 0;
      let details = "";

      t.questions.forEach((q, j) => {
        const chosen = form.querySelector(`input[name="q${j}"]:checked`);
        const ans = chosen ? chosen.value : "No Answer";
        const ok = ans === q.answer;
        if (ok) score++;

        details += `
          <div class="border rounded p-3" style="border-color: var(--border)">
            <div class="font-semibold ${ok ? 'text-green-600' : 'text-red-600'}">${ok ? '✔ Correct' : '✘ Incorrect'}</div>
            <div class="mt-1"><span class="text-[var(--muted)]">Q${j+1}:</span> ${q.q}</div>
            <div class="text-sm mt-1">Your answer: <span class="${ok ? 'text-green-600' : 'text-red-600'}">${ans}</span></div>
            <div class="text-sm">Correct: <span style="color: var(--blue)">${q.answer}</span></div>
          </div>
        `;
      });

      const total = t.questions.length;
      const percent = total ? (score/total) : 0;
      bar.style.width = `${percent*100}%`;
      bar.style.background = percent >= .6 ? "var(--green)" : "var(--red)";
      setRing(percent, percent >= .6 ? "var(--green)" : "var(--red)");

      scoreText.innerHTML = `You scored <span class="${percent>=.6 ? 'text-green-600' : 'text-red-600'}">${score}</span> out of ${total}` + (auto ? ` • <span class="text-[var(--muted)]">auto-submitted</span>` : "");
      answerDetails.innerHTML = details;
      resultCard.classList.remove("hidden");

      // Lock inputs
      form.querySelectorAll("input[type=radio]").forEach(i => i.disabled = true);
      submitBtn.disabled = true; submitBtn.style.opacity = .6; submitBtn.style.cursor = "not-allowed";

      // Celebrate on pass
      if (percent >= .8) fireConfetti();
      saveHistory(t.title, score, total);
    }

    // CLEAR ANSWERS
    clearBtn.addEventListener("click", () => {
      const answered = form.querySelector('input[type="radio"]:checked');
      if (!answered) return;
      if (!confirm("Clear all selected answers?")) return;
      form.querySelectorAll('input[type="radio"]').forEach(i => i.checked = false);
      updateProgress();
    });

    // RESET TEST
    resetBtn.addEventListener("click", () => {
      if (!confirm("Reset this test? Your selections will be cleared.")) return;
      startTest(currentIndex);
    });

    // BACK
    backBtn.addEventListener("click", () => {
      if (timerInt && !confirm("A test is in progress. Go back and lose progress?")) return;
      clearInterval(timerInt);
      renderList();
    });

    // SUBMIT
    submitBtn.addEventListener("click", (e) => {
      e.preventDefault();
      const t = tests[currentIndex];
      const total = t.questions.length;
      const answered = Array.from(form.querySelectorAll('input[type="radio"]:checked'))
                        .map(i => i.name).filter((v,i,a) => a.indexOf(v) === i).length;
      if (answered < total) {
        const ok = confirm(`You have ${total - answered} unanswered question(s). Submit anyway?`);
        if (!ok) return;
      }
      submit(false);
    });

    // SHORTCUTS
    document.addEventListener("keydown", (e) => {
      if (testSection.classList.contains("hidden")) return;
      if (e.key.toLowerCase() === "s") { e.preventDefault(); submitBtn.click(); }
      if (e.key.toLowerCase() === "c") { e.preventDefault(); clearBtn.click(); }
      if (e.key.toLowerCase() === "n") { e.preventDefault(); focusNextQuestion(+1); }
      if (e.key.toLowerCase() === "p") { e.preventDefault(); focusNextQuestion(-1); }
    });
    function focusNextQuestion(delta) {
      const nodes = [...form.querySelectorAll("fieldset")];
      if (!nodes.length) return;
      const y = window.scrollY;
      const idx = nodes.findIndex(n => n.getBoundingClientRect().top + window.scrollY - 90 > y) - 1;
      const cur = Math.max(0, idx);
      const next = Math.min(nodes.length - 1, Math.max(0, cur + delta));
      nodes[next].scrollIntoView({ behavior: "smooth", block: "start" });
    }

    // HISTORY
    function saveHistory(title, score, total) {
      const key = `testHistory_${user.email}`;
      const h = JSON.parse(localStorage.getItem(key) || "[]");
      h.push({ title, score, total, date: new Date().toISOString() });
      localStorage.setItem(key, JSON.stringify(h));
    }

    // CONFETTI
    function fireConfetti() {
      const colors = ["#22c55e","#3b82f6","#a855f7","#f59e0b","#ef4444"];
      for (let i=0;i<80;i++) {
        const p = document.createElement("div");
        const size = Math.random()*8+4;
        p.style.cssText = `
          position: fixed; top: -10px; left: ${Math.random()*100}%;
          width:${size}px; height:${size}px; background:${colors[i%colors.length]};
          transform: translateY(0); opacity: .9; border-radius: 2px; z-index: 50;
          transition: transform 1.2s cubic-bezier(.2,.8,.2,1), opacity 1.2s;
        `;
        confettiWrap.appendChild(p);
        requestAnimationFrame(() => {
          const dx = (Math.random()*2-1) * 150;
          p.style.transform = `translate(${dx}px, ${window.innerHeight + 60}px) rotate(${Math.random()*720}deg)`;
          p.style.opacity = 0;
        });
        setTimeout(() => p.remove(), 1400);
      }
    }

    // INIT
    renderList();
  </script>
</body>
</html>