<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CodeMaster - JAVA Tests</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      /* Light Theme */
      --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg-secondary: #f8fafc;
      --bg-card: rgba(255, 255, 255, 0.95);
      --bg-glass: rgba(255, 255, 255, 0.1);
      --border: rgba(226, 232, 240, 0.8);
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --accent-primary: #3b82f6;
      --accent-secondary: #8b5cf6;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    .dark {
      /* Dark Theme */
      --bg-primary: linear-gradient(135deg, #1e3a8a 0%, #581c87 100%);
      --bg-secondary: #0f172a;
      --bg-card: rgba(30, 41, 59, 0.95);
      --bg-glass: rgba(30, 41, 59, 0.2);
      --border: rgba(51, 65, 85, 0.8);
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-muted: #64748b;
      --accent-primary: #60a5fa;
      --accent-secondary: #a78bfa;
      --success: #34d399;
      --warning: #fbbf24;
      --error: #f87171;
      --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    body {
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      transition: all 0.3s ease;
    }

    .gradient-bg {
      background: var(--bg-primary);
    }

    .glass-card {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 24px;
      box-shadow: var(--shadow);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .glass-card:hover {
      transform: translateY(-8px);
      box-shadow: var(--shadow-lg);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      border: none;
      border-radius: 16px;
      padding: 12px 24px;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn-primary:hover::before {
      left: 100%;
    }

    .progress-ring {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: conic-gradient(
        var(--ring-color, var(--accent-primary)) calc(var(--progress, 0) * 1%), 
        var(--border) 0
      );
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .progress-ring::after {
      content: '';
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: var(--bg-card);
      position: absolute;
    }

    .progress-text {
      position: relative;
      z-index: 1;
      font-weight: 700;
      color: var(--text-primary);
    }

    .nav-dot {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: var(--bg-card);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .nav-dot:hover {
      transform: scale(1.1);
      border-color: var(--accent-primary);
    }

    .nav-dot.answered {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }

    .nav-dot.current {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: white;
      transform: scale(1.15);
    }

    .question-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 24px;
      transition: all 0.3s ease;
    }

    .question-card.current {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .option-label {
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      margin: 8px 0;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .option-label:hover {
      border-color: var(--accent-primary);
      background: var(--bg-glass);
      transform: translateX(4px);
    }

    .option-label.selected {
      border-color: var(--accent-primary);
      background: rgba(59, 130, 246, 0.1);
    }

    .option-label.correct {
      border-color: var(--success);
      background: rgba(16, 185, 129, 0.1);
    }

    .option-label.incorrect {
      border-color: var(--error);
      background: rgba(239, 68, 68, 0.1);
    }

    .timer-badge {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px 16px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .timer-warning {
      background: rgba(245, 158, 11, 0.2);
      border-color: var(--warning);
      color: var(--warning);
    }

    .timer-danger {
      background: rgba(239, 68, 68, 0.2);
      border-color: var(--error);
      color: var(--error);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .floating-action {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 1000;
    }

    .confetti-particle {
      position: fixed;
      pointer-events: none;
      z-index: 2000;
    }

    .slide-in-right {
      animation: slideInRight 0.5s ease-out;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    .category-filter {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .filter-chip {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 8px 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }

    .filter-chip:hover,
    .filter-chip.active {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: white;
    }

    .search-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px 16px;
      width: 100%;
      max-width: 400px;
      transition: all 0.3s ease;
    }

    .search-box:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .stats-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .stats-number {
      font-size: 2rem;
      font-weight: 800;
      color: var(--accent-primary);
    }
  </style>
</head>

<body class="min-h-full">
  <!-- Header -->
  <header class="gradient-bg text-white sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
            <i class="fas fa-code text-xl"></i>
          </div>
          <div>
            <h1 class="text-2xl font-bold">CodeMaster</h1>
            <p class="text-white/80 text-sm">JAVA Assessment Platform</p>
          </div>
        </div>
        
        <div class="flex items-center gap-4">
          <div class="hidden md:flex items-center gap-2 text-sm bg-white/10 rounded-lg px-3 py-2">
            <i class="fas fa-keyboard"></i>
            <span>Shortcuts: N/P Navigate â€¢ S Submit â€¢ C Clear</span>
          </div>
          <button id="themeToggle" class="p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-all">
            <i class="fas fa-moon" id="themeIcon"></i>
          </button>
          <button id="fullscreenBtn" class="p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-all">
            <i class="fas fa-expand"></i>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-8">
    <!-- Dashboard Section -->
    <section id="dashboard-section" class="mb-8">
      <div class="grid md:grid-cols-4 gap-6 mb-8">
        <div class="stats-card">
          <div class="stats-number" id="totalTests">0</div>
          <div class="text-sm text-[var(--text-secondary)]">Total Tests</div>
        </div>
        <div class="stats-card">
          <div class="stats-number" id="completedTests">0</div>
          <div class="text-sm text-[var(--text-secondary)]">Completed</div>
        </div>
        <div class="stats-card">
          <div class="stats-number" id="averageScore">0%</div>
          <div class="text-sm text-[var(--text-secondary)]">Avg Score</div>
        </div>
        <div class="stats-card">
          <div class="stats-number" id="bestStreak">0</div>
          <div class="text-sm text-[var(--text-secondary)]">Best Streak</div>
        </div>
      </div>
    </section>

    <!-- Test List Section -->
    <section id="list-section">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
        <h2 class="text-3xl font-bold">Available Tests</h2>
        <div class="flex gap-4 w-full md:w-auto">
          <input type="text" id="searchInput" class="search-box" placeholder="Search tests...">
          <select id="difficultyFilter" class="search-box md:max-w-[200px]">
            <option value="">All Difficulties</option>
            <option value="beginner">Beginner</option>
            <option value="intermediate">Intermediate</option>
            <option value="advanced">Advanced</option>
          </select>
        </div>
      </div>

      <div class="category-filter" id="categoryFilter">
        <div class="filter-chip active" data-category="">All Categories</div>
      </div>

      <div class="grid md:grid-cols-2 xl:grid-cols-3 gap-6" id="testsGrid"></div>
    </section>

    <!-- Test Interface -->
    <section id="test-section" class="hidden">
      <div class="grid lg:grid-cols-[280px,1fr] gap-8">
        <!-- Enhanced Navigator -->
        <aside class="glass-card p-6 h-fit sticky top-24">
          <div class="text-center mb-6">
            <div class="progress-ring mx-auto mb-4" id="progressRing">
              <div class="progress-text" id="progressText">0%</div>
            </div>
            <div id="timer" class="timer-badge">
              <i class="fas fa-clock mr-2"></i>
              <span>00:00</span>
            </div>
          </div>

          <div class="mb-6">
            <div class="text-sm text-[var(--text-secondary)] mb-2">Progress</div>
            <div class="bg-[var(--border)] rounded-full h-2">
              <div id="progressBar" class="h-2 rounded-full bg-[var(--accent-primary)] transition-all duration-300" style="width: 0%"></div>
            </div>
            <div class="text-xs text-[var(--text-muted)] mt-1" id="progressLabel">0 / 0 answered</div>
          </div>

          <div class="mb-6">
            <div class="text-sm text-[var(--text-secondary)] mb-3">Questions</div>
            <div id="navGrid" class="grid grid-cols-5 gap-2"></div>
          </div>

          <button id="backBtn" class="w-full btn-primary">
            <i class="fas fa-arrow-left mr-2"></i>
            Back to Tests
          </button>
        </aside>

        <!-- Enhanced Test Paper -->
        <div class="glass-card p-8">
          <div class="mb-8">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h2 id="testTitle" class="text-3xl font-bold mb-2"></h2>
                <p id="testMeta" class="text-[var(--text-secondary)]"></p>
              </div>
              <div class="flex gap-2">
                <span class="px-3 py-1 bg-[var(--accent-primary)] text-white rounded-full text-xs font-medium">Timed</span>
                <span class="px-3 py-1 bg-[var(--success)] text-white rounded-full text-xs font-medium">Auto-Save</span>
              </div>
            </div>
          </div>

          <form id="testForm" class="space-y-6"></form>

          <div class="border-t border-[var(--border)] pt-6 mt-8">
            <div class="flex flex-wrap gap-4">
              <button id="submitBtn" class="btn-primary">
                <i class="fas fa-paper-plane mr-2"></i>
                Submit Test
              </button>
              <button id="clearBtn" class="px-6 py-3 bg-[var(--warning)] text-white rounded-2xl font-semibold transition-all hover:transform hover:-translate-y-1">
                <i class="fas fa-eraser mr-2"></i>
                Clear All
              </button>
              <button id="saveProgressBtn" class="px-6 py-3 bg-[var(--success)] text-white rounded-2xl font-semibold transition-all hover:transform hover:-translate-y-1">
                <i class="fas fa-save mr-2"></i>
                Save Progress
              </button>
              <button id="resetBtn" class="px-6 py-3 bg-[var(--text-muted)] text-white rounded-2xl font-semibold transition-all hover:transform hover:-translate-y-1">
                <i class="fas fa-redo mr-2"></i>
                Reset
              </button>
            </div>
          </div>

          <!-- Enhanced Results -->
          <div id="resultCard" class="hidden mt-8 glass-card p-6">
            <div class="text-center mb-6">
              <div class="text-2xl font-bold mb-2">Test Results</div>
              <div id="scoreDisplay" class="text-4xl font-bold mb-2"></div>
              <div id="scoreMessage" class="text-[var(--text-secondary)]"></div>
            </div>

            <div class="grid md:grid-cols-3 gap-4 mb-6">
              <div class="text-center p-4 bg-[var(--bg-secondary)] rounded-xl">
                <div class="text-xl font-bold text-[var(--success)]" id="correctCount">0</div>
                <div class="text-sm text-[var(--text-secondary)]">Correct</div>
              </div>
              <div class="text-center p-4 bg-[var(--bg-secondary)] rounded-xl">
                <div class="text-xl font-bold text-[var(--error)]" id="incorrectCount">0</div>
                <div class="text-sm text-[var(--text-secondary)]">Incorrect</div>
              </div>
              <div class="text-center p-4 bg-[var(--bg-secondary)] rounded-xl">
                <div class="text-xl font-bold text-[var(--text-muted)]" id="unansweredCount">0</div>
                <div class="text-sm text-[var(--text-secondary)]">Unanswered</div>
              </div>
            </div>

            <div id="answerReview" class="space-y-4"></div>

            <div class="flex gap-4 mt-6">
              <button id="retakeBtn" class="btn-primary flex-1">
                <i class="fas fa-redo mr-2"></i>
                Retake Test
              </button>
              <button id="shareBtn" class="px-6 py-3 bg-[var(--accent-secondary)] text-white rounded-2xl font-semibold transition-all hover:transform hover:-translate-y-1">
                <i class="fas fa-share mr-2"></i>
                Share Result
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Floating Action Button -->
  <div class="floating-action">
    <button id="helpBtn" class="w-14 h-14 rounded-full bg-[var(--accent-primary)] text-white shadow-lg hover:shadow-xl transition-all hover:scale-110">
      <i class="fas fa-question"></i>
    </button>
  </div>

  <!-- Confetti Container -->
  <div id="confetti" class="pointer-events-none fixed inset-0 z-50"></div>

  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="glass-card p-8 text-center">
      <div class="animate-spin w-12 h-12 border-4 border-[var(--accent-primary)] border-t-transparent rounded-full mx-auto mb-4"></div>
      <div class="text-lg font-semibold">Loading Tests...</div>
    </div>
  </div>

  <script>
    // Global variables
    let tests = [];
    let currentTestIndex = null;
    let currentQuestionIndex = 0;
    let timerInterval = null;
    let remainingTime = 0;
    let userAnswers = {};
    let testStartTime = null;


    // DOM elements
    const elements = {
      dashboard: document.getElementById('dashboard-section'),
      listSection: document.getElementById('list-section'),
      testSection: document.getElementById('test-section'),
      testsGrid: document.getElementById('testsGrid'),
      searchInput: document.getElementById('searchInput'),
      difficultyFilter: document.getElementById('difficultyFilter'),
      categoryFilter: document.getElementById('categoryFilter'),
      testTitle: document.getElementById('testTitle'),
      testMeta: document.getElementById('testMeta'),
      testForm: document.getElementById('testForm'),
      progressRing: document.getElementById('progressRing'),
      progressText: document.getElementById('progressText'),
      progressBar: document.getElementById('progressBar'),
      progressLabel: document.getElementById('progressLabel'),
      timer: document.getElementById('timer'),
      navGrid: document.getElementById('navGrid'),
      submitBtn: document.getElementById('submitBtn'),
      clearBtn: document.getElementById('clearBtn'),
      saveProgressBtn: document.getElementById('saveProgressBtn'),
      resetBtn: document.getElementById('resetBtn'),
      backBtn: document.getElementById('backBtn'),
      resultCard: document.getElementById('resultCard'),
      scoreDisplay: document.getElementById('scoreDisplay'),
      scoreMessage: document.getElementById('scoreMessage'),
      correctCount: document.getElementById('correctCount'),
      incorrectCount: document.getElementById('incorrectCount'),
      unansweredCount: document.getElementById('unansweredCount'),
      answerReview: document.getElementById('answerReview'),
      retakeBtn: document.getElementById('retakeBtn'),
      shareBtn: document.getElementById('shareBtn'),
      themeToggle: document.getElementById('themeToggle'),
      themeIcon: document.getElementById('themeIcon'),
      fullscreenBtn: document.getElementById('fullscreenBtn'),
      helpBtn: document.getElementById('helpBtn'),
      loadingSpinner: document.getElementById('loadingSpinner'),
      confetti: document.getElementById('confetti')
    };

    // Initialize application
    async function init() {
      try {
        // Try to load from programming.json, fallback to sample data
        try {
          const response = await fetch('java.json');
          if (response.ok) {
            tests = await response.json();
          } else {
            throw new Error('Failed to load java.json');
          }
        } catch (error) {
          console.warn('Using sample data:', error.message);
          tests = sampleTests;
        }

        initializeTheme();
        setupEventListeners();
        renderDashboard();
        renderTestList();
        hideLoading();
      } catch (error) {
        console.error('Initialization error:', error);
        hideLoading();
      }
    }

    // Theme management
    function initializeTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      if (savedTheme === 'dark') {
        document.documentElement.classList.add('dark');
        elements.themeIcon.className = 'fas fa-sun';
      }
    }

    function toggleTheme() {
      document.documentElement.classList.toggle('dark');
      const isDark = document.documentElement.classList.contains('dark');
      elements.themeIcon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    // Event listeners
    function setupEventListeners() {
      elements.themeToggle.addEventListener('click', toggleTheme);
      elements.fullscreenBtn.addEventListener('click', toggleFullscreen);
      elements.searchInput.addEventListener('input', filterTests);
      elements.difficultyFilter.addEventListener('change', filterTests);
      elements.backBtn.addEventListener('click', goBackToList);
      elements.submitBtn.addEventListener('click', submitTest);
      elements.clearBtn.addEventListener('click', clearAllAnswers);
      elements.saveProgressBtn.addEventListener('click', saveProgress);
      elements.resetBtn.addEventListener('click', resetTest);
      elements.retakeBtn.addEventListener('click', retakeTest);
      elements.shareBtn.addEventListener('click', shareResults);
      elements.helpBtn.addEventListener('click', showHelp);

      // Keyboard shortcuts
      document.addEventListener('keydown', handleKeyboard);

      // Auto-save progress
      setInterval(autoSaveProgress, 30000); // Every 30 seconds
    }

    // Dashboard functions
    function renderDashboard() {
      const stats = calculateStats();
      document.getElementById('totalTests').textContent = stats.total;
      document.getElementById('completedTests').textContent = stats.completed;
      document.getElementById('averageScore').textContent = stats.averageScore + '%';
      document.getElementById('bestStreak').textContent = stats.bestStreak;
    }

    function calculateStats() {
      const history = getTestHistory();
      return {
        total: tests.length,
        completed: history.length,
        averageScore: history.length > 0 ? Math.round(history.reduce((acc, test) => acc + (test.score / test.total * 100), 0) / history.length) : 0,
        bestStreak: calculateBestStreak(history)
      };
    }

    function calculateBestStreak(history) {
      let currentStreak = 0;
      let bestStreak = 0;
      
      history.forEach(test => {
        if (test.score / test.total >= 0.8) {
          currentStreak++;
          bestStreak = Math.max(bestStreak, currentStreak);
        } else {
          currentStreak = 0;
        }
      });
      
      return bestStreak;
    }

    // Test list functions
    function renderTestList() {
      const categories = [...new Set(tests.map(test => test.category))];
      renderCategoryFilter(categories);
      renderTests(tests);
    }

    function renderCategoryFilter(categories) {
      const filterHTML = `
        <div class="filter-chip active" data-category="">All Categories</div>
        ${categories.map(cat => `<div class="filter-chip" data-category="${cat}">${cat}</div>`).join('')}
      `;
      elements.categoryFilter.innerHTML = filterHTML;

      elements.categoryFilter.addEventListener('click', (e) => {
        if (e.target.classList.contains('filter-chip')) {
          document.querySelectorAll('.filter-chip').forEach(chip => chip.classList.remove('active'));
          e.target.classList.add('active');
          filterTests();
        }
      });
    }

    function renderTests(testsToRender) {
      const testsHTML = testsToRender.map((test, index) => {
        const difficulty = test.difficulty || 'intermediate';
        const difficultyColor = {
          beginner: 'bg-green-100 text-green-800',
          intermediate: 'bg-yellow-100 text-yellow-800',
          advanced: 'bg-red-100 text-red-800'
        };

        const history = getTestHistory().filter(h => h.title === test.title);
        const bestScore = history.length > 0 ? Math.max(...history.map(h => h.score / h.total * 100)) : null;

        return `
          <div class="glass-card p-6 fade-in" style="animation-delay: ${index * 0.1}s">
            <div class="flex justify-between items-start mb-4">
              <h3 class="text-xl font-bold">${test.title}</h3>
              <span class="px-3 py-1 rounded-full text-xs font-medium ${difficultyColor[difficulty] || difficultyColor.intermediate}">
                ${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}
              </span>
            </div>
            
            <p class="text-[var(--text-secondary)] mb-4 line-clamp-2">${test.description || 'Test your programming knowledge with this comprehensive assessment.'}</p>
            
            <div class="flex items-center gap-4 mb-4 text-sm text-[var(--text-muted)]">
              <span><i class="fas fa-question-circle mr-1"></i> ${test.questions.length} questions</span>
              <span><i class="fas fa-clock mr-1"></i> ${test.duration} min</span>
              <span><i class="fas fa-tag mr-1"></i> ${test.category}</span>
            </div>

            ${bestScore !== null ? `
              <div class="mb-4 p-3 bg-[var(--bg-secondary)] rounded-lg">
                <div class="text-sm text-[var(--text-secondary)]">Best Score</div>
                <div class="text-lg font-bold text-[var(--success)]">${Math.round(bestScore)}%</div>
              </div>
            ` : ''}
            
            <button class="btn-primary w-full" onclick="startTest(${tests.indexOf(test)})">
              <i class="fas fa-play mr-2"></i>
              ${bestScore !== null ? 'Retake Test' : 'Start Test'}
            </button>
          </div>
        `;
      }).join('');

      elements.testsGrid.innerHTML = testsHTML;
    }

    function filterTests() {
      const searchTerm = elements.searchInput.value.toLowerCase();
      const difficultyFilter = elements.difficultyFilter.value;
      const categoryFilter = document.querySelector('.filter-chip.active').dataset.category;

      const filteredTests = tests.filter(test => {
        const matchesSearch = test.title.toLowerCase().includes(searchTerm) || 
                            (test.description && test.description.toLowerCase().includes(searchTerm));
        const matchesDifficulty = !difficultyFilter || test.difficulty === difficultyFilter;
        const matchesCategory = !categoryFilter || test.category === categoryFilter;
        
        return matchesSearch && matchesDifficulty && matchesCategory;
      });

      renderTests(filteredTests);
    }

    // Test execution functions
    function startTest(testIndex) {
      currentTestIndex = testIndex;
      currentQuestionIndex = 0;
      userAnswers = {};
      testStartTime = new Date();

      const test = tests[testIndex];
      
      // Load saved progress if available
      loadSavedProgress();

      // Setup UI
      elements.listSection.style.display = 'none';
      elements.testSection.style.display = 'block';
      elements.testSection.classList.add('slide-in-right');
      
      elements.testTitle.textContent = test.title;
      elements.testMeta.textContent = `${test.questions.length} questions â€¢ ${test.duration} minutes â€¢ ${test.category}`;

      renderQuestions();
      setupNavigator();
      startTimer();
      updateProgress();
    }

    function renderQuestions() {
      const test = tests[currentTestIndex];
      const questionsHTML = test.questions.map((question, index) => {
        const savedAnswer = userAnswers[index];
        
        return `
          <div class="question-card ${index === currentQuestionIndex ? 'current' : ''}" id="question-${index}">
            <div class="mb-4">
              <h3 class="text-lg font-semibold mb-2">Question ${index + 1}</h3>
              <p class="text-[var(--text-primary)]">${question.q}</p>
            </div>
            
            <div class="space-y-3">
              ${question.options.map(option => {
                const optionId = `q${index}-${option.replace(/\W+/g, '-')}`;
                const isSelected = savedAnswer === option;
                
                return `
                  <label class="option-label ${isSelected ? 'selected' : ''}" for="${optionId}">
                    <input 
                      type="radio" 
                      id="${optionId}" 
                      name="q${index}" 
                      value="${option}"
                      ${isSelected ? 'checked' : ''}
                      onchange="handleAnswerChange(${index}, '${option}')"
                    >
                    <span class="flex-1">${option}</span>
                  </label>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }).join('');

      elements.testForm.innerHTML = questionsHTML;
    }

    function handleAnswerChange(questionIndex, answer) {
      userAnswers[questionIndex] = answer;
      updateProgress();
      
      // Update option styling
      const questionCard = document.getElementById(`question-${questionIndex}`);
      questionCard.querySelectorAll('.option-label').forEach(label => {
        label.classList.remove('selected');
      });
      
      const selectedLabel = questionCard.querySelector(`input[value="${answer}"]`).closest('.option-label');
      selectedLabel.classList.add('selected');
      
      // Auto-save
      autoSaveProgress();
    }

    function setupNavigator() {
      const test = tests[currentTestIndex];
      const navHTML = test.questions.map((_, index) => {
        const isAnswered = userAnswers.hasOwnProperty(index);
        const isCurrent = index === currentQuestionIndex;
        
        return `
          <div class="nav-dot ${isAnswered ? 'answered' : ''} ${isCurrent ? 'current' : ''}" 
               onclick="navigateToQuestion(${index})">
            ${index + 1}
          </div>
        `;
      }).join('');

      elements.navGrid.innerHTML = navHTML;
    }

    function navigateToQuestion(questionIndex) {
      currentQuestionIndex = questionIndex;
      document.getElementById(`question-${questionIndex}`).scrollIntoView({ 
        behavior: 'smooth', 
        block: 'center' 
      });
      updateCurrentQuestion();
    }

    function updateCurrentQuestion() {
      document.querySelectorAll('.question-card').forEach((card, index) => {
        card.classList.toggle('current', index === currentQuestionIndex);
      });
      
      document.querySelectorAll('.nav-dot').forEach((dot, index) => {
        dot.classList.toggle('current', index === currentQuestionIndex);
      });
    }

    function updateProgress() {
      const test = tests[currentTestIndex];
      const totalQuestions = test.questions.length;
      const answeredCount = Object.keys(userAnswers).length;
      const progress = totalQuestions > 0 ? answeredCount / totalQuestions : 0;

      // Update progress ring
      elements.progressRing.style.setProperty('--progress', progress * 100);
      elements.progressText.textContent = Math.round(progress * 100) + '%';

      // Update progress bar
      elements.progressBar.style.width = (progress * 100) + '%';
      elements.progressLabel.textContent = `${answeredCount} / ${totalQuestions} answered`;

      // Update navigator
      setupNavigator();

      // Update ring color based on progress
      const color = progress >= 0.8 ? 'var(--success)' : progress >= 0.5 ? 'var(--accent-primary)' : 'var(--warning)';
      elements.progressRing.style.setProperty('--ring-color', color);
    }

    function startTimer() {
      const test = tests[currentTestIndex];
      remainingTime = test.duration * 60;
      updateTimerDisplay();

      timerInterval = setInterval(() => {
        remainingTime--;
        updateTimerDisplay();

        if (remainingTime <= 0) {
          clearInterval(timerInterval);
          submitTest(true);
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(remainingTime / 60);
      const seconds = remainingTime % 60;
      const timeStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      elements.timer.innerHTML = `<i class="fas fa-clock mr-2"></i><span>${timeStr}</span>`;
      
      // Update timer styling based on remaining time
      elements.timer.className = 'timer-badge';
      if (remainingTime <= 60) {
        elements.timer.classList.add('timer-danger');
      } else if (remainingTime <= 300) {
        elements.timer.classList.add('timer-warning');
      }
    }

    // Test submission and results
    function submitTest(autoSubmit = false) {
      if (!autoSubmit) {
        const test = tests[currentTestIndex];
        const unanswered = test.questions.length - Object.keys(userAnswers).length;
        
        if (unanswered > 0) {
          const confirmSubmit = confirm(`You have ${unanswered} unanswered question(s). Submit anyway?`);
          if (!confirmSubmit) return;
        }
      }

      clearInterval(timerInterval);
      
      const results = calculateResults();
      displayResults(results, autoSubmit);
      saveTestHistory(results);
      
      if (results.percentage >= 80) {
        celebrateSuccess();
      }
    }

    function calculateResults() {
      const test = tests[currentTestIndex];
      let correct = 0;
      let incorrect = 0;
      let unanswered = 0;
      const questionResults = [];

      test.questions.forEach((question, index) => {
        const userAnswer = userAnswers[index];
        const isCorrect = userAnswer === question.answer;
        
        if (userAnswer === undefined) {
          unanswered++;
        } else if (isCorrect) {
          correct++;
        } else {
          incorrect++;
        }

        questionResults.push({
          question: question.q,
          userAnswer: userAnswer || 'No Answer',
          correctAnswer: question.answer,
          isCorrect,
          options: question.options
        });
      });

      const total = test.questions.length;
      const percentage = total > 0 ? Math.round((correct / total) * 100) : 0;

      return {
        correct,
        incorrect,
        unanswered,
        total,
        percentage,
        questionResults,
        testTitle: test.title,
        timeTaken: test.duration * 60 - remainingTime
      };
    }

    function displayResults(results, autoSubmit = false) {
      elements.resultCard.classList.remove('hidden');
      elements.resultCard.scrollIntoView({ behavior: 'smooth' });

      // Score display
      elements.scoreDisplay.textContent = `${results.correct}/${results.total} (${results.percentage}%)`;
      elements.scoreDisplay.style.color = results.percentage >= 80 ? 'var(--success)' : 
                                          results.percentage >= 60 ? 'var(--warning)' : 'var(--error)';

      // Score message
      let message = '';
      if (results.percentage >= 90) message = 'ðŸŽ‰ Excellent! Outstanding performance!';
      else if (results.percentage >= 80) message = 'ðŸ‘ Great job! Well done!';
      else if (results.percentage >= 60) message = 'ðŸ‘ Good work! Room for improvement.';
      else message = 'ðŸ’ª Keep practicing! You can do better!';
      
      if (autoSubmit) message += ' (Auto-submitted due to time limit)';
      elements.scoreMessage.textContent = message;

      // Stats
      elements.correctCount.textContent = results.correct;
      elements.incorrectCount.textContent = results.incorrect;
      elements.unansweredCount.textContent = results.unanswered;

      // Question review
      const reviewHTML = results.questionResults.map((result, index) => `
        <div class="border border-[var(--border)] rounded-lg p-4">
          <div class="flex items-start justify-between mb-2">
            <h4 class="font-semibold">Question ${index + 1}</h4>
            <span class="px-2 py-1 rounded text-xs font-medium ${
              result.isCorrect ? 'bg-green-100 text-green-800' : 
              result.userAnswer === 'No Answer' ? 'bg-gray-100 text-gray-800' : 'bg-red-100 text-red-800'
            }">
              ${result.isCorrect ? 'Correct' : result.userAnswer === 'No Answer' ? 'Unanswered' : 'Incorrect'}
            </span>
          </div>
          
          <p class="text-[var(--text-secondary)] mb-3">${result.question}</p>
          
          <div class="space-y-2 text-sm">
            <div>
              <span class="font-medium">Your answer:</span> 
              <span class="${result.isCorrect ? 'text-green-600' : 'text-red-600'}">${result.userAnswer}</span>
            </div>
            <div>
              <span class="font-medium">Correct answer:</span> 
              <span class="text-[var(--success)]">${result.correctAnswer}</span>
            </div>
          </div>
        </div>
      `).join('');

      elements.answerReview.innerHTML = reviewHTML;

      // Update progress ring for final score
      elements.progressRing.style.setProperty('--progress', results.percentage);
      elements.progressRing.style.setProperty('--ring-color', 
        results.percentage >= 80 ? 'var(--success)' : 
        results.percentage >= 60 ? 'var(--warning)' : 'var(--error)'
      );
      elements.progressText.textContent = results.percentage + '%';

      // Disable form inputs
      elements.testForm.querySelectorAll('input').forEach(input => input.disabled = true);
      elements.submitBtn.disabled = true;
      elements.submitBtn.style.opacity = '0.6';
    }

    // Utility functions
    function goBackToList() {
      if (timerInterval && !elements.resultCard.classList.contains('hidden')) {
        // Test is completed, safe to go back
      } else if (timerInterval) {
        const confirmLeave = confirm('Test is in progress. Are you sure you want to leave? Progress will be saved.');
        if (!confirmLeave) return;
        autoSaveProgress();
      }

      clearInterval(timerInterval);
      elements.testSection.style.display = 'none';
      elements.listSection.style.display = 'block';
      renderDashboard();
    }

    function clearAllAnswers() {
      const hasAnswers = Object.keys(userAnswers).length > 0;
      if (!hasAnswers) return;

      const confirmClear = confirm('Are you sure you want to clear all answers?');
      if (!confirmClear) return;

      userAnswers = {};
      elements.testForm.querySelectorAll('input[type="radio"]').forEach(input => {
        input.checked = false;
      });
      
      document.querySelectorAll('.option-label').forEach(label => {
        label.classList.remove('selected');
      });

      updateProgress();
    }

    function resetTest() {
      const confirmReset = confirm('Are you sure you want to reset the test? All progress will be lost.');
      if (!confirmReset) return;

      clearSavedProgress();
      startTest(currentTestIndex);
    }

    function retakeTest() {
      clearSavedProgress();
      elements.resultCard.classList.add('hidden');
      startTest(currentTestIndex);
    }

    function saveProgress() {
      autoSaveProgress();
      showNotification('Progress saved successfully!', 'success');
    }

    function autoSaveProgress() {
      if (currentTestIndex === null) return;

      const progressData = {
        testIndex: currentTestIndex,
        answers: userAnswers,
        remainingTime,
        timestamp: new Date().getTime()
      };

      localStorage.setItem(`test_progress_${currentTestIndex}`, JSON.stringify(progressData));
    }

    function loadSavedProgress() {
      const savedData = localStorage.getItem(`test_progress_${currentTestIndex}`);
      if (!savedData) return;

      try {
        const progressData = JSON.parse(savedData);
        
        // Check if save is recent (within 24 hours)
        const now = new Date().getTime();
        if (now - progressData.timestamp > 24 * 60 * 60 * 1000) {
          clearSavedProgress();
          return;
        }

        const confirmLoad = confirm('Found saved progress for this test. Would you like to continue where you left off?');
        if (confirmLoad) {
          userAnswers = progressData.answers || {};
          remainingTime = progressData.remainingTime || tests[currentTestIndex].duration * 60;
        }
      } catch (error) {
        console.error('Error loading saved progress:', error);
        clearSavedProgress();
      }
    }

    function clearSavedProgress() {
      localStorage.removeItem(`test_progress_${currentTestIndex}`);
    }

    function saveTestHistory(results) {
      const user = getCurrentUser();
      if (!user) return;

      const historyKey = `test_history_${user.email}`;
      const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
      
      history.push({
        title: results.testTitle,
        score: results.correct,
        total: results.total,
        percentage: results.percentage,
        timeTaken: results.timeTaken,
        date: new Date().toISOString(),
        category: tests[currentTestIndex].category,
        difficulty: tests[currentTestIndex].difficulty
      });

      localStorage.setItem(historyKey, JSON.stringify(history));
      clearSavedProgress();
    }

    function getTestHistory() {
      const user = getCurrentUser();
      if (!user) return [];
      
      const historyKey = `test_history_${user.email}`;
      return JSON.parse(localStorage.getItem(historyKey) || '[]');
    }

    function getCurrentUser() {
      try {
        return JSON.parse(localStorage.getItem('loggedInUser') || '{}');
      } catch {
        return {};
      }
    }

    function shareResults() {
      const results = calculateResults();
      const shareText = `I scored ${results.percentage}% on "${results.testTitle}" at CodeMaster! ðŸŽ¯\n\n${results.correct}/${results.total} correct answers.\n\nTry it yourself!`;
      
      if (navigator.share) {
        navigator.share({
          title: 'My Test Results - CodeMaster',
          text: shareText
        });
      } else {
        navigator.clipboard.writeText(shareText).then(() => {
          showNotification('Results copied to clipboard!', 'success');
        });
      }
    }

    function celebrateSuccess() {
      // Confetti animation
      const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7'];
      
      for (let i = 0; i < 100; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti-particle';
          confetti.style.cssText = `
            width: ${Math.random() * 10 + 5}px;
            height: ${Math.random() * 10 + 5}px;
            background: ${colors[Math.floor(Math.random() * colors.length)]};
            left: ${Math.random() * 100}vw;
            top: -10px;
            border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
            animation: confetti-fall ${Math.random() * 3 + 2}s linear forwards;
          `;
          
          elements.confetti.appendChild(confetti);
          
          setTimeout(() => {
            confetti.remove();
          }, 5000);
        }, i * 20);
      }
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
        elements.fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
      } else {
        document.exitFullscreen();
        elements.fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
      }
    }

    function showHelp() {
      const helpContent = `
        <div class="glass-card p-6 max-w-md mx-auto">
          <h3 class="text-xl font-bold mb-4">Keyboard Shortcuts</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span>Next Question</span>
              <kbd class="px-2 py-1 bg-gray-200 rounded">N</kbd>
            </div>
            <div class="flex justify-between">
              <span>Previous Question</span>
              <kbd class="px-2 py-1 bg-gray-200 rounded">P</kbd>
            </div>
            <div class="flex justify-between">
              <span>Submit Test</span>
              <kbd class="px-2 py-1 bg-gray-200 rounded">S</kbd>
            </div>
            <div class="flex justify-between">
              <span>Clear Answers</span>
              <kbd class="px-2 py-1 bg-gray-200 rounded">C</kbd>
            </div>
            <div class="flex justify-between">
              <span>Save Progress</span>
              <kbd class="px-2 py-1 bg-gray-200 rounded">Ctrl + S</kbd>
            </div>
          </div>
          <button onclick="this.parentElement.parentElement.remove()" class="btn-primary w-full mt-4">Got it!</button>
        </div>
      `;
      
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
      overlay.innerHTML = helpContent;
      document.body.appendChild(overlay);
      
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) overlay.remove();
      });
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 z-50 glass-card p-4 ${
        type === 'success' ? 'border-green-500' : 
        type === 'error' ? 'border-red-500' : 'border-blue-500'
      }`;
      notification.innerHTML = `
        <div class="flex items-center gap-2">
          <i class="fas fa-${type === 'success' ? 'check-circle text-green-500' : 
                        type === 'error' ? 'exclamation-circle text-red-500' : 
                        'info-circle text-blue-500'}"></i>
          <span>${message}</span>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    function handleKeyboard(e) {
      if (elements.testSection.style.display === 'none') return;
      
      const key = e.key.toLowerCase();
      
      if (key === 'n' && !e.ctrlKey) {
        e.preventDefault();
        const nextIndex = Math.min(currentQuestionIndex + 1, tests[currentTestIndex].questions.length - 1);
        navigateToQuestion(nextIndex);
      } else if (key === 'p' && !e.ctrlKey) {
        e.preventDefault();
        const prevIndex = Math.max(currentQuestionIndex - 1, 0);
        navigateToQuestion(prevIndex);
      } else if (key === 's' && !e.ctrlKey) {
        e.preventDefault();
        if (!elements.submitBtn.disabled) submitTest();
      } else if (key === 'c' && !e.ctrlKey) {
        e.preventDefault();
        clearAllAnswers();
      } else if (key === 's' && e.ctrlKey) {
        e.preventDefault();
        saveProgress();
      }
    }

    function hideLoading() {
      elements.loadingSpinner.style.display = 'none';
    }

    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes confetti-fall {
        to {
          transform: translateY(100vh) rotate(720deg);
          opacity: 0;
        }
      }
      
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
    `;
    document.head.appendChild(style);

    // Initialize the application
    document.addEventListener('DOMContentLoaded', init);

    // Auth check (commented out for demo purposes)
    
    const user = getCurrentUser();
    if (!user.email) {
      alert('Please login to access tests');
      window.location.href = 'index.html?auth=login';
    }
    
  </script>
</body>
</html>