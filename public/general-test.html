<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CodeMaster - General CS Tests</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      /* Light Theme */
      --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg-secondary: #f8fafc;
      --bg-card: rgba(255, 255, 255, 0.95);
      --border: rgba(226, 232, 240, 0.8);
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --accent-primary: #3b82f6;
      --accent-secondary: #8b5cf6;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .dark {
      /* Dark Theme */
      --bg-primary: linear-gradient(135deg, #1e3a8a 0%, #581c87 100%);
      --bg-secondary: #0f172a;
      --bg-card: rgba(30, 41, 59, 0.95);
      --border: rgba(51, 65, 85, 0.8);
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --accent-primary: #60a5fa;
      --accent-secondary: #a78bfa;
    }

    body {
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      transition: all .3s ease
    }

    .gradient-bg {
      background: var(--bg-primary)
    }

    .glass-card {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 24px;
      box-shadow: var(--shadow);
      transition: all .3s cubic-bezier(.4, 0, .2, 1)
    }

    .glass-card:hover {
      transform: translateY(-8px)
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: #fff;
      border: none;
      border-radius: 16px;
      padding: 12px 24px;
      font-weight: 600;
      transition: all .3s ease;
      position: relative;
      overflow: hidden
    }

    .btn-primary:hover {
      transform: translateY(-2px)
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, hsla(0, 0%, 100%, .2), transparent);
      transition: left .5s
    }

    .btn-primary:hover::before {
      left: 100%
    }

    .progress-ring {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: conic-gradient(var(--ring-color, var(--accent-primary)) calc(var(--progress, 0) * 1%), var(--border) 0);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative
    }

    .progress-ring::after {
      content: '';
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: var(--bg-card);
      position: absolute
    }

    .progress-text {
      position: relative;
      z-index: 1;
      font-weight: 700;
      color: var(--text-primary)
    }

    .nav-dot {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: var(--bg-card);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      transition: all .3s ease;
      cursor: pointer
    }

    .nav-dot:hover {
      transform: scale(1.1);
      border-color: var(--accent-primary)
    }

    .nav-dot.answered {
      background: var(--success);
      border-color: var(--success);
      color: #fff
    }

    .nav-dot.current {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: #fff;
      transform: scale(1.15)
    }

    .question-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 24px;
      transition: all .3s ease
    }

    .question-card.current {
      border-color: var(--accent-primary)
    }

    .option-label {
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      margin: 8px 0;
      cursor: pointer;
      transition: all .3s ease;
      display: flex;
      align-items: center;
      gap: 12px
    }

    .option-label:hover {
      border-color: var(--accent-primary);
      transform: translateX(4px)
    }

    .option-label.selected {
      border-color: var(--accent-primary);
      background: rgba(59, 130, 246, .1)
    }

    .option-label.correct {
      border-color: var(--success);
      background: rgba(16, 185, 129, .1)
    }

    .option-label.incorrect {
      border-color: var(--error);
      background: rgba(239, 68, 68, .1)
    }

    .timer-badge {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px 16px;
      font-weight: 600;
      transition: all .3s ease
    }

    .timer-warning {
      border-color: var(--warning);
      color: var(--warning)
    }

    .timer-danger {
      border-color: var(--error);
      color: var(--error);
      animation: pulse 1s infinite
    }

    @keyframes pulse {

      0%,
      to {
        opacity: 1
      }

      50% {
        opacity: .7
      }
    }

    .category-filter {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap
    }

    .filter-chip {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 8px 16px;
      cursor: pointer;
      transition: all .3s ease;
      font-size: .9rem
    }

    .filter-chip.active,
    .filter-chip:hover {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: #fff
    }

    .search-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px 16px;
      width: 100%;
      max-width: 400px;
      transition: all .3s ease
    }

    .search-box:focus {
      outline: 0;
      border-color: var(--accent-primary)
    }

    .stats-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      transition: all .3s ease
    }

    .stats-number {
      font-size: 2rem;
      font-weight: 800;
      color: var(--accent-primary)
    }
  </style>
</head>

<body class="min-h-full">
  <header class="gradient-bg text-white sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
            <i class="fas fa-sitemap text-xl"></i>
          </div>
          <div>
            <h1 class="text-2xl font-bold">CodeMaster</h1>
            <p class="text-white/80 text-sm">General CS Assessment Platform</p>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <div class="hidden md:flex items-center gap-2 text-sm bg-white/10 rounded-lg px-3 py-2">
            <i class="fas fa-keyboard"></i>
            <span>Shortcuts: N/P Navigate â€¢ S Submit â€¢ C Clear</span>
          </div>
          <button id="themeToggle" class="p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-all"><i
              class="fas fa-moon" id="themeIcon"></i></button>
          <button id="fullscreenBtn" class="p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-all"><i
              class="fas fa-expand"></i></button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-8">
    <section id="dashboard-section" class="mb-8">
      <div class="grid md:grid-cols-4 gap-6 mb-8">
        <div class="stats-card">
          <div class="stats-number" id="totalTests">0</div>
          <div class="text-sm text-[var(--text-secondary)]">Total Tests</div>
        </div>
        <div class="stats-card">
          <div class="stats-number" id="completedTests">0</div>
          <div class="text-sm text-[var(--text-secondary)]">Completed</div>
        </div>
        <div class="stats-card">
          <div class="stats-number" id="averageScore">0%</div>
          <div class="text-sm text-[var(--text-secondary)]">Avg Score</div>
        </div>
        <div class="stats-card">
          <div class="stats-number" id="bestStreak">0</div>
          <div class="text-sm text-[var(--text-secondary)]">Best Streak</div>
        </div>
      </div>
    </section>

    <section id="list-section">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
        <h2 class="text-3xl font-bold">Available General Tests</h2>
        <div class="flex gap-4 w-full md:w-auto">
          <input type="text" id="searchInput" class="search-box" placeholder="Search tests...">
          <select id="difficultyFilter" class="search-box md:max-w-[200px]">
            <option value="">All Difficulties</option>
            <option value="beginner">Beginner</option>
            <option value="intermediate">Intermediate</option>
            <option value="advanced">Advanced</option>
          </select>
        </div>
      </div>
      <div class="category-filter" id="categoryFilter">
        <div class="filter-chip active" data-category="">All Categories</div>
      </div>
      <div class="grid md:grid-cols-2 xl:grid-cols-3 gap-6" id="testsGrid"></div>
    </section>

    <section id="test-section" class="hidden">
    </section>
  </main>

  <div id="loadingSpinner" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="glass-card p-8 text-center">
      <div
        class="animate-spin w-12 h-12 border-4 border-[var(--accent-primary)] border-t-transparent rounded-full mx-auto mb-4">
      </div>
      <div class="text-lg font-semibold">Loading Tests...</div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCtwyVv3cCc8udicg09akTJvGpr5LgmXF4",
      authDomain: "codemaster-102b4.firebaseapp.com",
      projectId: "codemaster-102b4",
      storageBucket: "codemaster-102b4.appspot.com",
      messagingSenderId: "932558907143",
      appId: "1:932558907143:web:d6e3e034be1f2f955b87a2",
      measurementId: "G-E5M37X3LMH"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let tests = [];
    let currentUser = null;
    let currentTestIndex = null;
    let currentQuestionIndex = 0;
    let timerInterval = null;
    let remainingTime = 0;
    let userAnswers = {};
    let testStartTime = null;

    const sampleTests = [{
      title: "Sample Test",
      category: "General",
      difficulty: "beginner",
      duration: 5,
      description: "A sample test to ensure the app is working.",
      questions: [{ question: "What is 2 + 2?", options: ["3", "4", "5", "6"], answer: "4" }]
    }];

    const elements = {
      dashboard: document.getElementById('dashboard-section'),
      listSection: document.getElementById('list-section'),
      testSection: document.getElementById('test-section'),
      testsGrid: document.getElementById('testsGrid'),
      searchInput: document.getElementById('searchInput'),
      difficultyFilter: document.getElementById('difficultyFilter'),
      categoryFilter: document.getElementById('categoryFilter'),
      loadingSpinner: document.getElementById('loadingSpinner')
    };

    auth.onAuthStateChanged((user) => {
      if (user) {
        currentUser = user;
        if (!window.appInitialized) {
          init();
          window.appInitialized = true;
        }
      } else {
        alert("Please login to access tests.");
        window.location.href = "index.html?auth=login";
      }
    });

    async function init() {
      try {
        try {
          const response = await fetch('general.json');
          if (response.ok) {
            tests = await response.json();
          } else { throw new Error('Failed to load general.json'); }
        } catch (error) {
          console.warn('Using sample General data:', error.message);
          tests = sampleTests;
        }
        initializeTheme();
        setupEventListeners();
        await renderDashboard();
        await renderTestList();
        hideLoading();
      } catch (error) {
        console.error('Initialization error:', error);
        hideLoading();
      }
    }

    function initializeTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      if (savedTheme === 'dark') {
        document.documentElement.classList.add('dark');
        const themeIcon = document.getElementById('themeIcon');
        if (themeIcon) themeIcon.className = 'fas fa-sun';
      }
    }

    function toggleTheme() {
      document.documentElement.classList.toggle('dark');
      const isDark = document.documentElement.classList.contains('dark');
      const themeIcon = document.getElementById('themeIcon');
      if (themeIcon) themeIcon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    function setupEventListeners() {
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);
      document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
      elements.searchInput.addEventListener('input', filterTests);
      elements.difficultyFilter.addEventListener('change', filterTests);
      document.addEventListener('keydown', handleKeyboard); // Global keyboard listener
    }

    async function renderDashboard() {
      const stats = await calculateStats();
      document.getElementById('totalTests').textContent = stats.total;
      document.getElementById('completedTests').textContent = stats.completed;
      document.getElementById('averageScore').textContent = stats.averageScore + '%';
      document.getElementById('bestStreak').textContent = stats.bestStreak;
    }

    async function updateDashboardWithFilteredResults(filteredTests) {
      const history = await getTestHistory();
      const completedInFilter = history.filter(h => filteredTests.some(t => t.title === h.title));
      const averageScoreInFilter = completedInFilter.length > 0 ? Math.round(completedInFilter.reduce((acc, test) => acc + test.percentage, 0) / completedInFilter.length) : 0;
      const bestStreakInFilter = calculateBestStreak(completedInFilter);
      document.getElementById('totalTests').textContent = filteredTests.length;
      document.getElementById('completedTests').textContent = completedInFilter.length;
      document.getElementById('averageScore').textContent = averageScoreInFilter + '%';
      document.getElementById('bestStreak').textContent = bestStreakInFilter;
    }

    async function calculateStats() {
      const history = await getTestHistory();
      return {
        total: tests.length,
        completed: history.length,
        averageScore: history.length > 0 ? Math.round(history.reduce((acc, test) => acc + test.percentage, 0) / history.length) : 0,
        bestStreak: calculateBestStreak(history)
      };
    }

    function calculateBestStreak(history) {
      let currentStreak = 0, bestStreak = 0;
      // âœ… FIX: Use getTime() for JS Dates instead of toMillis()
      const sortedHistory = [...history].sort((a, b) => a.date.getTime() - b.date.getTime());
      sortedHistory.forEach(test => {
        if (test.percentage >= 80) {
          currentStreak++;
          bestStreak = Math.max(bestStreak, currentStreak);
        } else {
          currentStreak = 0;
        }
      });
      return bestStreak;
    }


    async function renderTestList() {
      const categories = [...new Set(tests.map(test => test.category).filter(Boolean))];
      renderCategoryFilter(categories);
      await renderTests(tests);
    }

    function renderCategoryFilter(categories) {
      elements.categoryFilter.innerHTML = `<div class="filter-chip active" data-category="">All Categories</div> ${categories.map(cat => `<div class="filter-chip" data-category="${cat}">${cat}</div>`).join('')}`;
      elements.categoryFilter.addEventListener('click', (e) => {
        if (e.target.classList.contains('filter-chip')) {
          document.querySelectorAll('.filter-chip').forEach(chip => chip.classList.remove('active'));
          e.target.classList.add('active');
          filterTests();
        }
      });
    }

    async function renderTests(testsToRender) {
      const history = await getTestHistory();
      elements.testsGrid.innerHTML = testsToRender.map((test, index) => {
        const difficulty = test.difficulty || 'intermediate';
        const difficultyColor = { beginner: 'bg-green-100 text-green-800', intermediate: 'bg-yellow-100 text-yellow-800', advanced: 'bg-red-100 text-red-800' };
        const testHistory = history.filter(h => h.title === test.title);
        const bestScore = testHistory.length > 0 ? Math.max(...testHistory.map(h => h.percentage)) : null;
        const escapedTitle = test.title.replace(/'/g, "\\'");
        return `
      <div class="glass-card p-6 fade-in" style="animation-delay: ${index * 0.1}s">
        <div class="flex justify-between items-start mb-4"><h3 class="text-xl font-bold">${test.title}</h3><span class="px-3 py-1 rounded-full text-xs font-medium ${difficultyColor[difficulty] || difficultyColor.intermediate}">${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}</span></div>
        <p class="text-sm text-[var(--text-secondary)] mb-4 line-clamp-2">${test.description || 'Test your knowledge.'}</p>
        <div class="flex items-center gap-4 mb-4 text-xs text-[var(--text-muted)]"><span><i class="fas fa-question-circle mr-1"></i> ${test.questions.length} questions</span><span><i class="fas fa-clock mr-1"></i> ${test.duration} min</span><span><i class="fas fa-tag mr-1"></i> ${test.category ?? 'General'}</span></div>
        ${bestScore !== null ? `<div class="mb-4 p-3 bg-[var(--bg-secondary)] rounded-lg"><div class="text-sm text-[var(--text-secondary)]">Best Score</div><div class="text-lg font-bold text-[var(--success)]">${Math.round(bestScore)}%</div></div>` : ''}
        <button class="btn-primary w-full" onclick="startTest('${escapedTitle}')"><i class="fas fa-play mr-2"></i> ${bestScore !== null ? 'Retake Test' : 'Start Test'}</button>
      </div>`;
      }).join('');
    }

    async function filterTests() {
      const searchTerm = elements.searchInput.value.toLowerCase();
      const difficultyFilter = elements.difficultyFilter.value;
      const categoryFilter = document.querySelector('.filter-chip.active').dataset.category;
      const filteredTests = tests.filter(test => {
        const matchesSearch = test.title.toLowerCase().includes(searchTerm) || (test.description && test.description.toLowerCase().includes(searchTerm));
        const matchesDifficulty = !difficultyFilter || test.difficulty === difficultyFilter;
        const matchesCategory = !categoryFilter || test.category === categoryFilter;
        return matchesSearch && matchesDifficulty && matchesCategory;
      });
      await renderTests(filteredTests);
      await updateDashboardWithFilteredResults(filteredTests);
    }

    function startTest(testTitle) {
      const testIndex = tests.findIndex(test => test.title === testTitle);
      if (testIndex === -1) return console.error("Test not found:", testTitle);

      currentTestIndex = testIndex;
      currentQuestionIndex = 0;
      userAnswers = {};
      testStartTime = new Date();
      const test = tests[testIndex];

      elements.listSection.style.display = 'none';
      elements.testSection.innerHTML = `
    <div class="grid lg:grid-cols-[280px,1fr] gap-8">
        <aside class="glass-card p-6 h-fit sticky top-24">
            <div class="text-center mb-6"><div class="progress-ring mx-auto mb-4" id="progressRing"><div class="progress-text" id="progressText">0%</div></div><div id="timer" class="timer-badge"><i class="fas fa-clock mr-2"></i><span>00:00</span></div></div>
            <div class="mb-6"><div class="text-sm text-[var(--text-secondary)] mb-2">Progress</div><div class="bg-[var(--border)] rounded-full h-2"><div id="progressBar" class="h-2 rounded-full bg-[var(--accent-primary)] transition-all duration-300" style="width:0%"></div></div><div class="text-xs text-[var(--text-muted)] mt-1" id="progressLabel">0 / 0 answered</div></div>
            <div class="mb-6"><div class="text-sm text-[var(--text-secondary)] mb-3">Questions</div><div id="navGrid" class="grid grid-cols-5 gap-2"></div></div>
            <button id="backBtnDynamic" class="w-full btn-primary"><i class="fas fa-arrow-left mr-2"></i> Back to Tests</button>
        </aside>
        <div id="testPaper" class="glass-card p-8">
            <div class="mb-8"><div class="flex justify-between items-start mb-4"><div><h2 id="testTitleDynamic" class="text-3xl font-bold mb-2"></h2><p id="testMetaDynamic" class="text-[var(--text-secondary)]"></p></div><div class="flex gap-2"><span class="px-3 py-1 bg-[var(--accent-primary)] text-white rounded-full text-xs font-medium">Timed</span><span class="px-3 py-1 bg-[var(--success)] text-white rounded-full text-xs font-medium">Auto-Save</span></div></div></div>
            <form id="testFormDynamic" class="space-y-6"></form>
            <div class="border-t border-[var(--border)] pt-6 mt-8"><div class="flex flex-wrap gap-4"><button id="submitBtnDynamic" class="btn-primary"><i class="fas fa-paper-plane mr-2"></i> Submit Test</button><button id="clearBtnDynamic" class="px-6 py-3 bg-[var(--warning)] text-white rounded-2xl font-semibold transition-all hover:transform hover:-translate-y-1"><i class="fas fa-eraser mr-2"></i> Clear All</button></div></div>
            <div id="resultCardDynamic" class="hidden mt-8 glass-card p-6">
                <div class="text-center mb-6"><div class="text-2xl font-bold mb-2">Test Results</div><div id="scoreDisplayDynamic" class="text-4xl font-bold mb-2"></div><div id="scoreMessageDynamic" class="text-[var(--text-secondary)]"></div></div>
                <div class="grid md:grid-cols-3 gap-4 mb-6">
                    <div class="text-center p-4 bg-[var(--bg-secondary)] rounded-xl"><div class="text-xl font-bold text-[var(--success)]" id="correctCountDynamic">0</div><div class="text-sm text-[var(--text-secondary)]">Correct</div></div>
                    <div class="text-center p-4 bg-[var(--bg-secondary)] rounded-xl"><div class="text-xl font-bold text-[var(--error)]" id="incorrectCountDynamic">0</div><div class="text-sm text-[var(--text-secondary)]">Incorrect</div></div>
                    <div class="text-center p-4 bg-[var(--bg-secondary)] rounded-xl"><div class="text-xl font-bold text-[var(--text-muted)]" id="unansweredCountDynamic">0</div><div class="text-sm text-[var(--text-secondary)]">Unanswered</div></div>
                </div>
                <div id="answerReviewDynamic" class="space-y-4"></div>
                <div class="flex gap-4 mt-6"><button id="retakeBtnDynamic" class="btn-primary flex-1"><i class="fas fa-redo mr-2"></i> Retake Test</button><button id="shareBtnDynamic" class="px-6 py-3 bg-[var(--accent-secondary)] text-white rounded-2xl font-semibold transition-all hover:transform hover:-translate-y-1"><i class="fas fa-share mr-2"></i> Share Result</button></div>
            </div>
        </div>
    </div>`;
      elements.testSection.style.display = 'block';
      elements.testSection.classList.add('slide-in-right');

      const testPaper = document.getElementById('testPaper');
      if (testPaper) {
        testPaper.setAttribute('tabindex', '-1');
        testPaper.focus({ preventScroll: true });
      }

      document.getElementById('backBtnDynamic').addEventListener('click', goBackToList);
      document.getElementById('submitBtnDynamic').addEventListener('click', () => submitTest(false));
      document.getElementById('clearBtnDynamic').addEventListener('click', clearAllAnswers);

      document.getElementById('testTitleDynamic').textContent = test.title;
      document.getElementById('testMetaDynamic').textContent = `${test.questions.length} questions â€¢ ${test.duration} minutes â€¢ ${test.category ?? 'General'}`;

      loadSavedProgress();
      renderQuestions();
      setupNavigator();
      startTimer();
      updateProgress();
    }

    function renderQuestions() {
      const test = tests[currentTestIndex];
      const testForm = document.getElementById('testFormDynamic');
      if (!testForm) return;
      testForm.innerHTML = test.questions.map((question, index) => {
        const savedAnswer = userAnswers[index];
        return `
      <div class="question-card ${index === currentQuestionIndex ? 'current' : ''}" id="question-${index}">
        <div class="mb-4"><h3 class="text-lg font-semibold mb-2">Question ${index + 1}</h3><p class="text-[var(--text-primary)]">${question.question.replace(/\n/g, '<br>')}</p></div>
        <div class="space-y-3">
          ${question.options.map(option => {
          const optionId = `q${index}-${option.replace(/\W+/g, '-')}`;
          const isSelected = savedAnswer === option;
          const encodedOption = option.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
          return `<label class="option-label ${isSelected ? 'selected' : ''}" for="${optionId}"><input type="radio" id="${optionId}" name="q${index}" value="${encodedOption}" ${isSelected ? 'checked' : ''} onchange="handleAnswerChange(${index}, this.value)"><span class="flex-1">${option}</span></label>`;
        }).join('')}
        </div>
      </div>`;
      }).join('');
    }

    function handleAnswerChange(questionIndex, answer) {
      userAnswers[questionIndex] = answer;
      updateProgress();
      const questionCard = document.getElementById(`question-${questionIndex}`);
      questionCard.querySelectorAll('.option-label').forEach(label => label.classList.remove('selected'));
      const selectedLabel = questionCard.querySelector(`input[value="${answer.replace(/"/g, '&quot;')}"]`).closest('.option-label');
      if (selectedLabel) selectedLabel.classList.add('selected');
      autoSaveProgress();
    }

    function setupNavigator() {
      const test = tests[currentTestIndex];
      const navGrid = document.getElementById('navGrid');
      if (!navGrid) return;
      navGrid.innerHTML = test.questions.map((_, index) => {
        const isAnswered = userAnswers.hasOwnProperty(index);
        const isCurrent = index === currentQuestionIndex;
        return `<div class="nav-dot ${isAnswered ? 'answered' : ''} ${isCurrent ? 'current' : ''}" onclick="navigateToQuestion(${index})">${index + 1}</div>`;
      }).join('');
    }

    function navigateToQuestion(questionIndex) {
      currentQuestionIndex = questionIndex;
      const questionEl = document.getElementById(`question-${questionIndex}`);
      if (questionEl) questionEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
      updateCurrentQuestion();
    }

    function updateCurrentQuestion() {
      document.querySelectorAll('.question-card').forEach((card, index) => card.classList.toggle('current', index === currentQuestionIndex));
      document.querySelectorAll('.nav-dot').forEach((dot, index) => dot.classList.toggle('current', index === currentQuestionIndex));
    }

    function updateProgress() {
      if (currentTestIndex === null) return;
      const test = tests[currentTestIndex];
      const totalQuestions = test.questions.length;
      const answeredCount = Object.keys(userAnswers).length;
      const progress = totalQuestions > 0 ? answeredCount / totalQuestions : 0;

      const progressRing = document.getElementById('progressRing');
      const progressText = document.getElementById('progressText');
      const progressBar = document.getElementById('progressBar');
      const progressLabel = document.getElementById('progressLabel');

      if (progressRing) {
        progressRing.style.setProperty('--progress', progress * 100);
        const color = progress >= 0.8 ? 'var(--success)' : progress >= 0.5 ? 'var(--accent-primary)' : 'var(--warning)';
        progressRing.style.setProperty('--ring-color', color);
      }
      if (progressText) progressText.textContent = `${Math.round(progress * 100)}%`;
      if (progressBar) progressBar.style.width = `${progress * 100}%`;
      if (progressLabel) progressLabel.textContent = `${answeredCount} / ${totalQuestions} answered`;

      setupNavigator();
    }

    function startTimer() {
      const test = tests[currentTestIndex];
      if (remainingTime === 0) remainingTime = test.duration * 60;
      clearInterval(timerInterval);
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        remainingTime--;
        updateTimerDisplay();
        if (remainingTime <= 0) {
          clearInterval(timerInterval);
          submitTest(true);
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(remainingTime / 60);
      const seconds = remainingTime % 60;
      const timeStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      const timerEl = document.getElementById('timer');
      if (timerEl) {
        timerEl.innerHTML = `<i class="fas fa-clock mr-2"></i><span>${timeStr}</span>`;
        timerEl.className = 'timer-badge';
        if (remainingTime <= 60) timerEl.classList.add('timer-danger');
        else if (remainingTime <= 300) timerEl.classList.add('timer-warning');
      }
    }

    async function submitTest(autoSubmit = false) {
      if (!autoSubmit) {
        const test = tests[currentTestIndex];
        const unanswered = test.questions.length - Object.keys(userAnswers).length;
        if (unanswered > 0 && !confirm(`You have ${unanswered} unanswered question(s). Submit anyway?`)) return;
      }
      clearInterval(timerInterval);
      const results = calculateResults();
      displayResults(results, autoSubmit);
      await saveTestHistory(results);
      if (results.percentage >= 80) celebrateSuccess();
    }

    function calculateResults() {
      const test = tests[currentTestIndex];
      let correct = 0;
      const questionResults = test.questions.map((q, index) => {
        const userAnswer = userAnswers[index];
        const isCorrect = userAnswer === q.answer;
        if (isCorrect) correct++;
        // âœ… FIX: Use q.question to match the JSON file
        return { question: q.question, userAnswer: userAnswer || 'No Answer', correctAnswer: q.answer, isCorrect };
      });
      const total = test.questions.length;
      const percentage = total > 0 ? Math.round((correct / total) * 100) : 0;
      return { correct, incorrect: total - correct - (total - Object.keys(userAnswers).length), unanswered: total - Object.keys(userAnswers).length, total, percentage, questionResults, testTitle: test.title, timeTaken: (test.duration * 60) - remainingTime };
    }

    function displayResults(results, autoSubmit = false) {
      document.getElementById('resultCardDynamic').classList.remove('hidden');
      document.getElementById('scoreDisplayDynamic').textContent = `${results.correct}/${results.total} (${results.percentage}%)`;
      document.getElementById('scoreDisplayDynamic').style.color = results.percentage >= 80 ? 'var(--success)' : results.percentage >= 60 ? 'var(--warning)' : 'var(--error)';
      let message = 'ðŸ’ª Keep practicing!';
      if (results.percentage >= 90) message = 'ðŸŽ‰ Excellent!';
      if (autoSubmit) message += ' (Auto-submitted)';
      document.getElementById('scoreMessageDynamic').textContent = message;
      document.getElementById('correctCountDynamic').textContent = results.correct;
      document.getElementById('incorrectCountDynamic').textContent = results.incorrect;
      document.getElementById('unansweredCountDynamic').textContent = results.unanswered;
      document.getElementById('answerReviewDynamic').innerHTML = results.questionResults.map((result, index) => `
    <div class="border border-[var(--border)] rounded-lg p-4">
      <div class="flex items-start justify-between mb-2">
        <h4 class="font-semibold">Question ${index + 1}</h4>
        <span class="px-2 py-1 rounded text-xs font-medium ${result.isCorrect ? 'bg-green-100 text-green-800' : result.userAnswer === 'No Answer' ? 'bg-gray-100 text-gray-800' : 'bg-red-100 text-red-800'}">${result.isCorrect ? 'Correct' : result.userAnswer === 'No Answer' ? 'Unanswered' : 'Incorrect'}</span>
      </div>
      <p class="text-[var(--text-secondary)] mb-3">${result.question.replace(/\n/g, '<br>')}</p>
      <div class="space-y-2 text-sm">
        <div><span class="font-medium">Your answer:</span> <span class="${result.isCorrect ? 'text-green-600' : 'text-red-600'}">${result.userAnswer}</span></div>
        <div><span class="font-medium">Correct answer:</span> <span class="text-[var(--success)]">${result.correctAnswer}</span></div>
      </div>
    </div>`).join('');
      document.getElementById('retakeBtnDynamic').addEventListener('click', () => {
        clearSavedProgress();
        startTest(tests[currentTestIndex].title);
      });
      document.getElementById('shareBtnDynamic').addEventListener('click', shareResults);
      document.getElementById('submitBtnDynamic').disabled = true;
    }

    async function goBackToList() {
      if (timerInterval && document.getElementById('resultCardDynamic')?.classList.contains('hidden')) {
        if (!confirm('Test is in progress. Are you sure?')) return;
        autoSaveProgress();
      }
      clearInterval(timerInterval);
      timerInterval = null;
      elements.testSection.innerHTML = '';
      elements.testSection.style.display = 'none';
      elements.listSection.style.display = 'block';
      await renderDashboard();
      await renderTestList();
    }

    function clearAllAnswers() {
      const testForm = document.getElementById('testFormDynamic');
      if (Object.keys(userAnswers).length > 0 && confirm('Are you sure you want to clear all answers?')) {
        userAnswers = {};
        if (testForm) testForm.reset();
        document.querySelectorAll('.option-label').forEach(label => label.classList.remove('selected'));
        updateProgress();
      }
    }

    // âœ… FIX: Removed the old, incompatible retakeTest and resetTest functions.
    // Their logic is now handled by event listeners attached to the dynamic buttons.

    function saveProgress() { autoSaveProgress(); showNotification('Progress saved!', 'success'); }

    function autoSaveProgress() {
      if (currentTestIndex === null || !document.getElementById('resultCardDynamic')?.classList.contains('hidden')) return;
      const progressData = { answers: userAnswers, remainingTime, timestamp: new Date().getTime() };
      localStorage.setItem(`test_progress_${currentUser.uid}_${tests[currentTestIndex].title}`, JSON.stringify(progressData));
    }

    function loadSavedProgress() {
      if (currentTestIndex === null) return;
      const testTitle = tests[currentTestIndex].title;
      const savedData = localStorage.getItem(`test_progress_${currentUser.uid}_${testTitle}`);
      if (!savedData) { remainingTime = 0; return; }
      try {
        const progressData = JSON.parse(savedData);
        if ((new Date().getTime() - progressData.timestamp > 24 * 60 * 60 * 1000) || !confirm('Found saved progress. Continue?')) {
          clearSavedProgress(); remainingTime = 0; return;
        }
        userAnswers = progressData.answers || {};
        remainingTime = progressData.remainingTime || 0;
      } catch (error) {
        console.error('Error loading saved progress:', error);
        clearSavedProgress();
      }
    }

    function clearSavedProgress() {
      if (currentTestIndex !== null) {
        const testTitle = tests[currentTestIndex].title;
        localStorage.removeItem(`test_progress_${currentUser.uid}_${testTitle}`);
      }
    }

    async function saveTestHistory(results) {
      if (!currentUser) return;
      try {
        const testData = tests[currentTestIndex];
        await db.collection("users").doc(currentUser.uid).collection("history").add({
          title: results.testTitle, score: results.correct, total: results.total, percentage: results.percentage,
          timeTaken: results.timeTaken, date: new Date(), category: testData.category ?? 'General',
          difficulty: testData.difficulty ?? 'intermediate'
        });
        showNotification('Results saved to your profile!', 'success');
        clearSavedProgress();
      } catch (error) {
        console.error("Error saving test history:", error);
        showNotification('Could not save results to profile.', 'error');
      }
    }

    async function getTestHistory() {
      if (!currentUser) return [];
      try {
        const snapshot = await db.collection("users").doc(currentUser.uid).collection("history").orderBy("date", "desc").get();
        return snapshot.docs.map(doc => {
          const data = doc.data();
          return { ...data, date: data.date.toDate() };
        });
      } catch (error) {
        console.error("Error getting test history:", error);
        return [];
      }
    }

    function shareResults() {
      const results = calculateResults();
      const shareText = `I scored ${results.percentage}% on "${results.testTitle}" at CodeMaster! ðŸŽ¯\n\n${results.correct}/${results.total} correct answers. Try it yourself!`;
      if (navigator.share) {
        navigator.share({ title: 'My Test Results - CodeMaster', text: shareText });
      } else {
        navigator.clipboard.writeText(shareText).then(() => showNotification('Results copied to clipboard!', 'success'));
      }
    }

    function celebrateSuccess() {
      // This function is not used in the new structure but can be kept for future use
    }

    function toggleFullscreen() {
      const fullscreenBtn = document.getElementById('fullscreenBtn');
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
        if (fullscreenBtn) fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
      } else {
        document.exitFullscreen();
        if (fullscreenBtn) fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
      }
    }

    function handleKeyboard(e) {
      // Use a more robust check for visibility
      if (elements.testSection.style.display !== 'block') return;

      const key = e.key.toLowerCase();

      // Check if the event target is an input field, to avoid conflicts
      const targetTagName = e.target.tagName.toLowerCase();
      if (targetTagName === 'input' || targetTagName === 'textarea' || targetTagName === 'select') {
        // Allow keyboard shortcuts only if they don't interfere with typing
        if (key !== 'n' && key !== 'p' && key !== 's' && key !== 'c') {
          return;
        }
      }

      const actionMap = {
        'n': () => navigateToQuestion(Math.min(currentQuestionIndex + 1, tests[currentTestIndex].questions.length - 1)),
        'p': () => navigateToQuestion(Math.max(currentQuestionIndex - 1, 0)),
        's': () => document.getElementById('submitBtnDynamic')?.click(),
        'c': () => document.getElementById('clearBtnDynamic')?.click()
      };

      if (actionMap[key]) {
        e.preventDefault();
        actionMap[key]();
      }
    }

    function hideLoading() { elements.loadingSpinner.style.display = 'none'; }

    const style = document.createElement('style');
    style.textContent = `@keyframes confetti-fall { to { transform: translateY(100vh) rotate(720deg); opacity: 0; } } .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }`;
    document.head.appendChild(style);

  </script>
</body>

</html>